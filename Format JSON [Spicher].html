<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" dir="ltr" lang="fr"><head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>
    Format JSON    [Spicher]
  </title>

  <meta name="generator" content="DokuWiki Release 2009-12-25c &quot;Lemming&quot;">
<meta name="robots" content="index,follow">
<meta name="date" content="2018-12-07T16:21:59+0100">
<meta name="keywords" content="l2info,progc,json">
<link rel="search" type="application/opensearchdescription+xml" href="http://lacl.fr/~aspicher/Wiki/lib/exe/opensearch.php" title="Spicher">
<link rel="start" href="http://lacl.fr/~aspicher/Wiki/">
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="http://lacl.fr/~aspicher/Wiki/feed.php">
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="http://lacl.fr/~aspicher/Wiki/feed.php?mode=list&amp;ns=l2info:progc">
<link rel="alternate" type="text/html" title="Plain HTML" href="http://lacl.fr/~aspicher/Wiki/_export/xhtml/l2info/progc/json">
<link rel="canonical" href="http://lacl.fr/~aspicher/Wiki/l2info/progc/json">
<link rel="stylesheet" media="all" type="text/css" href="Format%20JSON%20[Spicher]_fichiers/css.css">
<link rel="stylesheet" media="screen" type="text/css" href="Format%20JSON%20[Spicher]_fichiers/css_002.css">
<link rel="stylesheet" media="print" type="text/css" href="Format%20JSON%20[Spicher]_fichiers/css_003.css">
<script type="text/javascript" charset="utf-8"><!--//--><![CDATA[//><!--
var NS='l2info:progc';var SIG=' --- //[[antoine.spicher@u-pec.fr|L2 Informatique]] 2018/12/15 18:15//';var JSINFO = {"id":"l2info:progc:json","namespace":"l2info:progc"};
//--><!]]></script>
<script type="text/javascript" charset="utf-8" src="Format%20JSON%20[Spicher]_fichiers/js.php"></script>

  <link rel="shortcut icon" href="http://lacl.fr/~aspicher/Wiki/lib/tpl/default/images/favicon.ico">

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="http://lacl.fr/~aspicher/Wiki/l2info/progc/json?do=backlink" title="Liens vers cette page">Format JSON</a>]]
      </div>
      <div class="logo">
        <a href="http://lacl.fr/~aspicher/Wiki/" name="dokuwiki__top" id="dokuwiki__top" accesskey="h" title="[H]">Spicher</a>      </div>

      <div class="clearer"></div>
    </div>

    
    <div class="bar" id="bar__top">
      <div class="bar-left" id="bar__topleft">
                      </div>

      <div class="bar-right" id="bar__topright">
                &nbsp;
      </div>

      <div class="clearer"></div>
    </div>

        <div class="breadcrumbs">
      <span class="bchead">Piste:</span> <span class="bcsep">»</span> <span class="curid"><a href="http://lacl.fr/~aspicher/Wiki/l2info/progc/json" class="breadcrumbs" title="l2info:progc:json">Format JSON</a></span>          </div>
    
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <!-- TOC START -->
<div class="toc">
<div class="tocheader toctoggle" id="toc__header" style="cursor: pointer;"><span id="toc__toggle" style="cursor: pointer;" class="toc_close"><span>−</span></span>Table des matières</div>
<div id="toc__inside">

<ul class="toc">
<li class="level1"><div class="li"><span class="li"><a href="#format_json" class="toc">Format JSON</a></span></div>
<ul class="toc">
<li class="level2"><div class="li"><span class="li"><a href="#description_du_format" class="toc">Description du format</a></span></div></li>
<li class="level2"><div class="li"><span class="li"><a href="#bibliotheque_demandee" class="toc">Bibliothèque demandée</a></span></div>
<ul class="toc">
<li class="level3"><div class="li"><span class="li"><a href="#types_constructeurs_accesseurs_et_destructeurs" class="toc">Types, constructeurs, accesseurs et destructeurs</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#entreessorties" class="toc">Entrées/sorties</a></span></div></li>
<li class="level3"><div class="li"><span class="li"><a href="#test" class="toc">Test</a></span></div></li></ul>
</li></ul>
</li></ul>
</div>
</div>
<!-- TOC END -->



<h1><a name="format_json" id="format_json">Format JSON</a></h1>
<div class="level1">

</div>

<h2><a name="description_du_format" id="description_du_format">Description du format</a></h2>
<div class="level2">

<p>

Le format <a href="https://fr.wikipedia.org/wiki/JavaScript_Object_Notation" class="urlextern" title="https://fr.wikipedia.org/wiki/JavaScript_Object_Notation" rel="nofollow">JSON</a>
 est un format générique qui permet l'échange de données structurées.
Il est actuellement le format le plus populaire pour le développement 
des nouvelles générations de base de données, avec par exemple l'outil 
MongoDB.
Les langages de programmation de haut-niveau sont souvent dotés d'une 
bibliothèque d'import/export de données JSON.
Nous proposons ici d'en développer une pour le langage <code>C</code>.
</p>

<p>
Voici un exemple de code JSON :

</p>
<dl class="code">
<dt><a href="http://lacl.fr/~aspicher/Wiki/_export/code/l2info/progc/json?codeblock=0" title="Télécharger un extrait" class="mediafile mf_json">example.json</a></dt>
<dd><pre class="code json">[ { "id" : "bk101",
    "author" : {
      "lastname" : "Gambardelle",
      "firstname" : "Matthew"
    },
    "title": "XML Developer's Guide",
    "genre" : "Computer",
    "price" : 44.95,
    "publish_date" : "2000-10-01",
    "description" : "An in-depth look at creating applications with XML.",
    "available" : true
  },
  { "id" : "bk102",
    "author" : {
      "lastname" : "Ralls",
      "firstname" : "Kim"
    },
    "title": "Midnight Rain",
    "genre" : "Fantasy",
    "price" : 5.95,
    "publish_date" : "2000-12-16",
    "description" : "A former architect battles corporate zombies, an evil sorceress, and her own childhood to become queen of the world.",
    "available" : true
  },
  { "id" : "bk103",
    "author" : null,
    "title": "The Book With No Name",
    "genre" : "Thriller",
    "price" : 21.00,
    "publish_date" : "2006-07-08",
    "description" : "Santa Mondega is no ordinary town, and its inhabitants are even less ordinary: gangsters, martial-arts monks, low-lifes, bounty hunters, vampires and Elvis-impersonating hitmen abound. And then, in the shadowed streets, there lurks the serial killer known only as the Bourbon Kid.",
    "available" : false
  }
]</pre>
</dd></dl>

<p>
Comme on peut le constater dans cet exemple, JSON permet de définir des 
données quelconque (ici il s'agit d'une liste de livres mais cela aurait
 pu être n'importe quel autre type de données) sous une forme 
arborescente.
Ici, on décrit une liste de livres comme étant un tableau dont chaque 
entrée est un livre.
Chaque livre est lui-même décrit en précisant son auteur, son titre, son
 genre, son prix, etc.
</p>

<p>
Un fichier au format JSON contient simplement un <em>élément</em> JSON, celui-ci pouvant contenir des sous-éléments imbriqués pour constituer ainsi un arbre de données.
Il n'existe que quelques types d'éléments JSON :
</p>
<ul>
<li class="level1"><div class="li"> l'<em>absence</em> de données représentée par l'identifiant <code>null</code></div>
</li>
<li class="level1"><div class="li"> les <em>booléens</em> avec les constantes <code>true</code> et <code>false</code></div>
</li>
<li class="level1"><div class="li"> les <em>nombres</em> représentés au format décimal (JSON ne fait pas la différence entre les entiers et les nombres flottants)</div>
</li>
<li class="level1"><div class="li"> les <em>chaînes de caractères</em> représentées entre guillemets</div>
</li>
<li class="level1"><div class="li"> les <em>tableaux</em> notés entre crochets <code>[ … ]</code> et contenant une suite d'éléments JSON séparés par des virgules</div>
</li>
<li class="level1"><div class="li"> les <em>objets</em> notés entre accolade <code>{ … }</code> et contenant une liste dont les <em>membres</em>, séparés par des virgules, représentent des associations <em>clé-valeur</em>; syntaxiquement, un membre prend la forme d'une chaîne de caractères (la clé), suivi du caractère <code>”:”</code>, suivi d'un élément JSON arbitraire (la valeur)</div>
</li>
</ul>

<p>
L'exemple ci-dessus contient tous les types d'éléments.
</p>

</div>

<h2><a name="bibliotheque_demandee" id="bibliotheque_demandee">Bibliothèque demandée</a></h2>
<div class="level2">

</div>

<h3><a name="types_constructeurs_accesseurs_et_destructeurs" id="types_constructeurs_accesseurs_et_destructeurs">Types, constructeurs, accesseurs et destructeurs</a></h3>
<div class="level3">

</div>

<h4><a name="type" id="type">Type</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Utiliser le type <pre class="code c"><span class="kw4">typedef</span> <span class="kw2">enum</span> <span class="br0">{</span>
  JSON_NULL<span class="sy0">,</span>
  JSON_BOOLEAN<span class="sy0">,</span>
  JSON_NUMBER<span class="sy0">,</span>
  JSON_STRING<span class="sy0">,</span>
  JSON_ARRAY<span class="sy0">,</span>
  JSON_OBJECT
<span class="br0">}</span> json_type_t<span class="sy0">;</span></pre>

<p>
 pour représenter les différents types d'éléments JSON
</p>
</div>
</li>
<li class="level1"><div class="li"> Définir le type <code>json_element_t</code> représentant un élément JSON ; la spécification du type ne devra pas être diffusé dans le <em>header</em>; on rappelle qu'un élément JSON est :</div>
<ul>
<li class="level2"><div class="li"> <strong>soit</strong> <code>null</code> : on utilisera le pointeur <code>NULL</code> pour représenter l'absence d'information</div>
</li>
<li class="level2"><div class="li"> <strong>soit</strong> un booléen : on utilisera le type <code>bool</code> de <code>stdbool.h</code> pour les représenter)</div>
</li>
<li class="level2"><div class="li"> <strong>soit</strong> un nombre : votre encodage devra permettre de distinguer les nombres entiers (<code>long</code>) des nombres flottants (<code>double</code>)</div>
</li>
<li class="level2"><div class="li"> <strong>soit</strong> une chaîne de caractères (<code>char*</code>)</div>
</li>
<li class="level2"><div class="li"> <strong>soit</strong> un tableau d'éléments JSON : on utilisera un tableau contenant des pointeurs vers des éléments JSON (<code>json_element_t* *</code>) dont la taille s'adaptera (<code>realloc</code>) automatiquement selon les mises à jour (cf. ci-dessous)</div>
</li>
<li class="level2"><div class="li"> <strong>soit</strong> un object contenant une liste de couples <em>clé-valeur</em> : on utilisera une liste chaînée dont chaque élément contient la clé (<code>char*</code>) et la valeur (<code>json_element_t*</code>), dont le contenu évoluera automatiquement selon les mises à jour (cf. ci-dessous)</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>json_type_t json_type(const json_element_t* e)</code> retournant le type de l'élément JSON <code>e</code></div>
</li>
</ul>

</div>

<h4><a name="absence_d_information" id="absence_d_information">Absence d'information</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Définir dans le <em>header</em> la macro <code>json_null()</code> égale au pointeur <code>NULL</code> converti en <code>json_element_t*</code></div>
</li>
</ul>

</div>

<h4><a name="booleens" id="booleens">Booléens</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Définir le constructeur <code>json_element_t* json_boolean(bool b)</code> allouant un nouvel élément JSON de type booléen de valeur <code>b</code></div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>bool json_as_boolean(const json_element_t* e)</code> retournant la valeur d'un élément JSON de type booléen ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
</ul>

</div>

<h4><a name="nombres" id="nombres">Nombres</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Définir le constructeur <code>json_element_t* json_integer(long i)</code> allouant un nouvel élément JSON de type nombre de valeur entière <code>i</code></div>
</li>
<li class="level1"><div class="li"> Définir le constructeur <code>json_element_t* json_double(double d)</code> allouant un nouvel élément JSON de type nombre de valeur flottante <code>d</code></div>
</li>
<li class="level1"><div class="li"> Définir le prédicat <code>bool json_is_integer(const json_element_t* e)</code> retournant si un élément JSON de type nombre contient un entier ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
<li class="level1"><div class="li"> Définir le prédicat <code>bool json_is_double(const json_element_t* e)</code> retournant si un élément JSON de type nombre contient un flottant ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>long json_as_integer(const json_element_t* e)</code> retournant la valeur d'un élément JSON de type nombre sous forme entière (si <code>e</code> contient un flottant, sa valeur sera convertie en <code>long</code> par un <em>cast</em>) ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>double json_as_double(const json_element_t* e)</code> retournant la valeur d'un élément JSON de type nombre sous forme flottante (si <code>e</code> contient un entier, sa valeur sera convertie en <code>double</code> par un <em>cast</em>) ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
</ul>

</div>

<h4><a name="chaines_de_caracteres" id="chaines_de_caracteres">Chaînes de caractères</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Définir le constructeur <code>json_element_t* json_string(const char* s)</code> allouant un nouvel élément JSON de type chaîne de caractères de valeur <code>s</code> ; on prendra soin de copier <code>s</code> au moment de l'initialisation</div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>const char* json_as_string(const json_element_t* e)</code> retournant la valeur d'un élément JSON de type chaîne de caractères ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
</ul>

</div>

<h4><a name="tableaux" id="tableaux">Tableaux</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Définir le constructeur <code>json_element_t* json_array()</code> allouant un nouvel élément JSON de type tableau initialement vide</div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>json_element_t* json_array_get(const json_element_t* e, size_t i)</code> retournant le <code>i</code>ème élément d'un élément JSON de type tableau (ou l'absence d'information si <code>e</code> ne contient pas de case <code>i</code>) ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>void json_array_set(json_element_t* e, size_t i, json_element_t* se)</code> remplaçant le <code>i</code>ème élément d'un élément JSON de type tableau (si la case <code>i</code> n'existe pas, le tableau sera automatiquement redimensionné avec <code>realloc</code> et les cases créées seront initialisées à l'absence d'information ; si la case <code>i</code> existe, l'ancienne valeur sera libérée par un appel à <code>json_free</code>) ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
</ul>

</div>

<h4><a name="objets" id="objets">Objets</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Définir le constructeur <code>json_element_t* json_object()</code> allouant un nouvel élément JSON de type objet initialement vide</div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>json_element_t* json_object_get(const json_element_t* e, const char* key)</code> retournant l'élément JSON associé à la clé <code>key</code> d'un élément JSON de type objet (ou l'absence d'information si <code>e</code> ne contient pas la clé <code>key</code>) ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>void json_objet_set(json_element_t* e, const char* key, json_element_t* value)</code> remplaçant l'élément JSON associé à la clé <code>key</code> dans un élément JSON de type objet (si la clé <code>key</code> n'existe pas, une nouvelle entrée sera automatiquement créée ; si la clé <code>key</code> existe, l'ancienne valeur associée sera libérée par un appel à <code>json_free</code>) ; si <code>e</code> n'est pas du bon type, la fonction échouera (message d'erreur + <code>EXIT_FAILURE</code>)</div>
</li>
</ul>

</div>

<h4><a name="destructeur" id="destructeur">Destructeur</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Définir le destructeur <code>void json_free(json_element_t* e)</code> libérant la mémoire occupée par l'élément <code>e</code> (et ses sous-éléments le cas échéant)</div>
</li>
</ul>

</div>

<h3><a name="entreessorties" id="entreessorties">Entrées/sorties</a></h3>
<div class="level3">

</div>

<h4><a name="export" id="export">Export</a></h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> Définir la fonction <code>void json_put(FILE* fd, const json_element_t* e)</code> qui sauvegarde l'élément <code>e</code> dans <code>fd</code> en utilisant la syntaxe JSON </div>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>void json_save(const char* fname, json_element_t* e)</code> qui sauvegarde l'élément <code>e</code> dans le fichier nommé <code>fname</code> (qui sera écrasé le cas échéant)</div>
</li>
</ul>

</div>

<h4><a name="import" id="import">Import</a></h4>
<div class="level4">

<p>

L'import d'un fichier JSON est une fonctionnalité autrement plus difficile à programmer que l'export.
Elle demande en effet à <em>parser</em> un fichier texte.
</p>
<ul>
<li class="level1"><div class="li"> Définir la fonction <code>json_element_t* json_get(FILE* fd)</code> qui charge un élément JSON <code>e</code> à partir de <code>fd</code> ; le code de cette fonction vous est donnée ci-dessous à condition de programmer les fonctions suivantes :</div>
<ul>
<li class="level2"><div class="li"> <code>char next_char(FILE* fd)</code> qui retourne le prochain caractère dans <code>fd</code>
 qui n'est pas un caractère d'espacement (c'est-à-dire ni ' ', ni '\n', 
ni '\r', ni '\t') ; le programme échouera si la fin de fichier est 
rencontrée</div>
</li>
<li class="level2"><div class="li"> <code>void check_next_char(FILE* fd, char c)</code> qui fait échouer le programme si le prochain caractère (<code>next_char</code>) n'est pas <code>c</code></div>
</li>
<li class="level2"><div class="li"> <code>bool is_next_char(FILE* fd, char c, bool cons)</code> qui vérifie si le prochain caractère (<code>next_char</code>) est <code>c</code> ; dans le cas contraire ou si <code>cons</code> est à faux, le prochain caractère ne sera pas consommé (utiliser <code>ungetc</code>)</div>
</li>
<li class="level2"><div class="li"> <code>void check_next_word(FILE* fd, const char* w)</code> qui fait échouer le programme si le prochain mot n'est pas <code>w</code> (utiliser <code>strcmp</code> pour comparer les mots)</div>
</li>
<li class="level2"><div class="li"> <code>char* next_string(FILE* fd)</code> qui consomme les caractères d'espacement jusqu'au prochain guillemet <code>”</code>
 (échoue dans le cas contraire) et retourne l'ensemble des caractères 
rencontrés jusqu'au guillemet suivant (qui sera consommé) ; la chaîne 
retournée sera allouée par la fonction (attention, il n'y a pas de 
limite de taille sur les chaînes)</div>
</li>
<li class="level2"><div class="li"> <code>char* next_digits(FILE* fd)</code>
 qui consomme les caractères d'espacement jusqu'au prochain chiffre 
(échoue dans le cas contraire) et retourne la suite des chiffres (sous 
forme de caractères) rencontrés jusqu'au prochain caractère qui n'est 
pas un chiffre (qui ne sera pas consommé ; utiliser <code>ungetc</code>) ; la chaîne retournée sera allouée par la fonction (attention, il n'y a pas de limite de taille sur ces suites)</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Définir la fonction <code>json_element_t* json_load(const char* fname)</code> qui charge un élément JSON <code>e</code> à partir du fichier nommé <code>fname</code> </div>
</li>
</ul>
<pre class="code c">json_element_t<span class="sy0">*</span> json_get<span class="br0">(</span>FILE<span class="sy0">*</span> fd<span class="br0">)</span> <span class="br0">{</span>
  <span class="kw4">int</span> c <span class="sy0">=</span> next_char<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
  <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'n'</span><span class="br0">)</span> <span class="br0">{</span>
    ungetc<span class="br0">(</span>c<span class="sy0">,</span>fd<span class="br0">)</span><span class="sy0">;</span>
    check_next_word<span class="br0">(</span>fd<span class="sy0">,</span><span class="st0">"null"</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="kw1">return</span> json_null<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
  <span class="br0">}</span>
  <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'t'</span><span class="br0">)</span> <span class="br0">{</span>
    ungetc<span class="br0">(</span>c<span class="sy0">,</span>fd<span class="br0">)</span><span class="sy0">;</span>
    check_next_word<span class="br0">(</span>fd<span class="sy0">,</span><span class="st0">"true"</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="kw1">return</span> json_boolean<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="sy0">;</span>
  <span class="br0">}</span>
  <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'f'</span><span class="br0">)</span> <span class="br0">{</span>
    ungetc<span class="br0">(</span>c<span class="sy0">,</span>fd<span class="br0">)</span><span class="sy0">;</span>
    check_next_word<span class="br0">(</span>fd<span class="sy0">,</span><span class="st0">"false"</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="kw1">return</span> json_boolean<span class="br0">(</span><span class="kw2">false</span><span class="br0">)</span><span class="sy0">;</span>
  <span class="br0">}</span>
  <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'-'</span><span class="br0">)</span> <span class="br0">{</span>
    json_element_t<span class="sy0">*</span> se <span class="sy0">=</span> json_get<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">(</span>json_type<span class="br0">(</span>se<span class="br0">)</span> <span class="sy0">!=</span> JSON_NUMBER<span class="br0">)</span> <span class="br0">{</span>
      fprintf<span class="br0">(</span>stderr<span class="sy0">,</span> <span class="st0">"A number is expected after character '-'<span class="es1">\n</span>"</span><span class="br0">)</span><span class="sy0">;</span>
      exit<span class="br0">(</span>EXIT_FAILURE<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span>
    <span class="kw1">if</span> <span class="br0">(</span>json_is_double<span class="br0">(</span>se<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
      <span class="kw4">double</span> d <span class="sy0">=</span> json_as_double<span class="br0">(</span>se<span class="br0">)</span><span class="sy0">;</span>
      json_free<span class="br0">(</span>se<span class="br0">)</span><span class="sy0">;</span>
      <span class="kw1">return</span> json_double<span class="br0">(</span><span class="sy0">-</span>d<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span>
    <span class="kw1">if</span> <span class="br0">(</span>json_is_integer<span class="br0">(</span>se<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
      <span class="kw4">long</span> i <span class="sy0">=</span> json_as_integer<span class="br0">(</span>se<span class="br0">)</span><span class="sy0">;</span>
      json_free<span class="br0">(</span>se<span class="br0">)</span><span class="sy0">;</span>
      <span class="kw1">return</span> json_integer<span class="br0">(</span><span class="sy0">-</span>i<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span>
  <span class="br0">}</span>
  <span class="kw1">if</span> <span class="br0">(</span><span class="st0">'0'</span> <span class="sy0">&lt;=</span> c <span class="sy0">&amp;&amp;</span> c <span class="sy0">&lt;=</span> <span class="st0">'9'</span><span class="br0">)</span> <span class="br0">{</span>
    ungetc<span class="br0">(</span>c<span class="sy0">,</span>fd<span class="br0">)</span><span class="sy0">;</span>
    <span class="kw4">char</span><span class="sy0">*</span> number <span class="sy0">=</span> next_digits<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
    c <span class="sy0">=</span> fgetc<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'.'</span><span class="br0">)</span> <span class="br0">{</span>
      <span class="kw4">char</span><span class="sy0">*</span> decimal <span class="sy0">=</span> next_digits<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
      number <span class="sy0">=</span> realloc<span class="br0">(</span>number<span class="sy0">,</span> strlen<span class="br0">(</span>number<span class="br0">)</span> <span class="sy0">+</span> strlen<span class="br0">(</span>decimal<span class="br0">)</span> <span class="sy0">+</span> 2<span class="br0">)</span><span class="sy0">;</span>
      strcat<span class="br0">(</span>number<span class="sy0">,</span><span class="st0">"."</span><span class="br0">)</span><span class="sy0">;</span>
      strcat<span class="br0">(</span>number<span class="sy0">,</span>decimal<span class="br0">)</span><span class="sy0">;</span>
      json_element_t<span class="sy0">*</span> e <span class="sy0">=</span> json_double<span class="br0">(</span>strtod<span class="br0">(</span>number<span class="sy0">,</span>NULL<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
      free<span class="br0">(</span>number<span class="br0">)</span><span class="sy0">;</span>
      free<span class="br0">(</span>decimal<span class="br0">)</span><span class="sy0">;</span>
      <span class="kw1">return</span> e<span class="sy0">;</span>
    <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
      ungetc<span class="br0">(</span>c<span class="sy0">,</span>fd<span class="br0">)</span><span class="sy0">;</span>
      json_element_t<span class="sy0">*</span> e <span class="sy0">=</span> json_integer<span class="br0">(</span>strtol<span class="br0">(</span>number<span class="sy0">,</span>NULL<span class="sy0">,</span>10<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
      free<span class="br0">(</span>number<span class="br0">)</span><span class="sy0">;</span>
      <span class="kw1">return</span> e<span class="sy0">;</span>
    <span class="br0">}</span>
  <span class="br0">}</span>
  <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'"'</span><span class="br0">)</span> <span class="br0">{</span>
    ungetc<span class="br0">(</span>c<span class="sy0">,</span>fd<span class="br0">)</span><span class="sy0">;</span>
    <span class="kw4">char</span><span class="sy0">*</span> str <span class="sy0">=</span> next_string<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
    json_element_t<span class="sy0">*</span> e <span class="sy0">=</span> json_string<span class="br0">(</span>str<span class="br0">)</span><span class="sy0">;</span>
    free<span class="br0">(</span>str<span class="br0">)</span><span class="sy0">;</span>
    <span class="kw1">return</span> e<span class="sy0">;</span>
  <span class="br0">}</span>
  <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'['</span><span class="br0">)</span> <span class="br0">{</span>
    json_element_t<span class="sy0">*</span> e <span class="sy0">=</span> json_array<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
    size_t i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">(</span>is_next_char<span class="br0">(</span>fd<span class="sy0">,</span><span class="st0">']'</span><span class="sy0">,</span><span class="kw2">true</span><span class="br0">)</span><span class="br0">)</span> <span class="kw1">return</span> e<span class="sy0">;</span>
    <span class="kw1">while</span><span class="br0">(</span>1<span class="br0">)</span> <span class="br0">{</span>
      json_element_t<span class="sy0">*</span> se <span class="sy0">=</span> json_get<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
      json_array_set<span class="br0">(</span>e<span class="sy0">,</span>i<span class="sy0">++,</span>se<span class="br0">)</span><span class="sy0">;</span>
      c <span class="sy0">=</span> next_char<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
      <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">']'</span><span class="br0">)</span> <span class="kw1">return</span> e<span class="sy0">;</span>
      <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">!=</span> <span class="st0">','</span><span class="br0">)</span> <span class="br0">{</span>
        fprintf<span class="br0">(</span>stderr<span class="sy0">,</span> <span class="st0">"Unexpected character '%c'; ']' or ',' excepted<span class="es1">\n</span>"</span><span class="sy0">,</span> c<span class="br0">)</span><span class="sy0">;</span>
        exit<span class="br0">(</span>EXIT_FAILURE<span class="br0">)</span><span class="sy0">;</span>
      <span class="br0">}</span>
    <span class="br0">}</span>
  <span class="br0">}</span>
  <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'{'</span><span class="br0">)</span> <span class="br0">{</span>
    json_element_t<span class="sy0">*</span> e <span class="sy0">=</span> json_object<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">(</span>is_next_char<span class="br0">(</span>fd<span class="sy0">,</span><span class="st0">'}'</span><span class="sy0">,</span><span class="kw2">true</span><span class="br0">)</span><span class="br0">)</span> <span class="kw1">return</span> e<span class="sy0">;</span>
    <span class="kw1">while</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
      check_next_char<span class="br0">(</span>fd<span class="sy0">,</span><span class="st0">'"'</span><span class="br0">)</span><span class="sy0">;</span>
      ungetc<span class="br0">(</span><span class="st0">'"'</span><span class="sy0">,</span>fd<span class="br0">)</span><span class="sy0">;</span>
      <span class="kw4">char</span><span class="sy0">*</span> key <span class="sy0">=</span> next_string<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
      check_next_char<span class="br0">(</span>fd<span class="sy0">,</span><span class="st0">':'</span><span class="br0">)</span><span class="sy0">;</span>
      json_element_t<span class="sy0">*</span> value <span class="sy0">=</span> json_get<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
      json_object_set<span class="br0">(</span>e<span class="sy0">,</span>key<span class="sy0">,</span>value<span class="br0">)</span><span class="sy0">;</span>
      c <span class="sy0">=</span> next_char<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
      <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">==</span> <span class="st0">'}'</span><span class="br0">)</span> <span class="kw1">return</span> e<span class="sy0">;</span>
      <span class="kw1">if</span> <span class="br0">(</span>c <span class="sy0">!=</span> <span class="st0">','</span><span class="br0">)</span> <span class="br0">{</span>
        fprintf<span class="br0">(</span>stderr<span class="sy0">,</span> <span class="st0">"Unexpected character '%c'; ']' or ',' excepted<span class="es1">\n</span>"</span><span class="sy0">,</span> c<span class="br0">)</span><span class="sy0">;</span>
        exit<span class="br0">(</span>EXIT_FAILURE<span class="br0">)</span><span class="sy0">;</span>
      <span class="br0">}</span>
    <span class="br0">}</span>
  <span class="br0">}</span>
  fprintf<span class="br0">(</span>stderr<span class="sy0">,</span> <span class="st0">"Unexpected character '%c'; 'n', 't', 'f', [0-9], '<span class="es1">\"</span>', '[' or '{' excepted<span class="es1">\n</span>"</span><span class="sy0">,</span> c<span class="br0">)</span><span class="sy0">;</span>
  exit<span class="br0">(</span>EXIT_FAILURE<span class="br0">)</span><span class="sy0">;</span>
<span class="br0">}</span></pre>

</div>

<h3><a name="test" id="test">Test</a></h3>
<div class="level3">

<p>

Voici un programme pour tester votre implémentation.
Le fichier <code>example.json</code> est celui donné précédemment.

</p>
<pre class="code c"><span class="co2">#include &lt;stdlib.h&gt;</span>
<span class="co2">#include &lt;stdio.h&gt;</span>
<span class="co2">#include "json.h"</span>
&nbsp;
<span class="co2">#define prl { printf("\n"); }</span>
&nbsp;
<span class="kw4">int</span> main<span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
  json_element_t<span class="sy0">*</span> e <span class="sy0">=</span> NULL<span class="sy0">;</span>
  e <span class="sy0">=</span> json_null<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span> json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
  e <span class="sy0">=</span> json_boolean<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="sy0">;</span> json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span> json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
  e <span class="sy0">=</span> json_boolean<span class="br0">(</span><span class="kw2">false</span><span class="br0">)</span><span class="sy0">;</span> json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span> json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
  e <span class="sy0">=</span> json_integer<span class="br0">(</span>123456L<span class="br0">)</span><span class="sy0">;</span> json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span> json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
  e <span class="sy0">=</span> json_double<span class="br0">(</span>123456.987654<span class="br0">)</span><span class="sy0">;</span> json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span> json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
  e <span class="sy0">=</span> json_string<span class="br0">(</span><span class="st0">"Un petit texte"</span><span class="br0">)</span><span class="sy0">;</span> json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span> json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
  e <span class="sy0">=</span> json_array<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span>
  json_array_set<span class="br0">(</span>e<span class="sy0">,</span> 0<span class="sy0">,</span> json_integer<span class="br0">(</span>1928374566L<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
  json_array_set<span class="br0">(</span>e<span class="sy0">,</span> <span class="nu0">3</span><span class="sy0">,</span> json_string<span class="br0">(</span><span class="st0">"Un autre texte"</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
  json_array_set<span class="br0">(</span>e<span class="sy0">,</span> 1<span class="sy0">,</span> json_boolean<span class="br0">(</span><span class="kw2">false</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
  json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span> json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
  e <span class="sy0">=</span> json_object<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span>
  json_object_set<span class="br0">(</span>e<span class="sy0">,</span> <span class="st0">"key1"</span><span class="sy0">,</span> json_integer<span class="br0">(</span>1928374566L<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
  json_object_set<span class="br0">(</span>e<span class="sy0">,</span> <span class="st0">"key2"</span><span class="sy0">,</span> json_string<span class="br0">(</span><span class="st0">"Un autre texte"</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
  json_object_set<span class="br0">(</span>e<span class="sy0">,</span> <span class="st0">"key3"</span><span class="sy0">,</span> json_boolean<span class="br0">(</span><span class="kw2">false</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
  json_object_set<span class="br0">(</span>e<span class="sy0">,</span> <span class="st0">"key2"</span><span class="sy0">,</span> json_string<span class="br0">(</span><span class="st0">"Un texte de remplacement"</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
  json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span> json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
&nbsp;
  FILE<span class="sy0">*</span> fd <span class="sy0">=</span> fopen<span class="br0">(</span><span class="st0">"example.json"</span><span class="sy0">,</span> <span class="st0">"r"</span><span class="br0">)</span><span class="sy0">;</span>
  e <span class="sy0">=</span> json_get<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
  fclose<span class="br0">(</span>fd<span class="br0">)</span><span class="sy0">;</span>
  json_put<span class="br0">(</span>stdout<span class="sy0">,</span> e<span class="br0">)</span><span class="sy0">;</span> prl<span class="sy0">;</span>
  json_free<span class="br0">(</span>e<span class="br0">)</span><span class="sy0">;</span>
  <span class="kw1">return</span> EXIT_SUCCESS<span class="sy0">;</span>
<span class="br0">}</span></pre>

<p>

En voici la sortie :

</p>
<pre class="code">null
true
false
123456
123456.98765400
"Un petit texte"
[]
[1928374566,false,null,"Un autre texte"]
{}
{"key1":1928374566,"key2":"Un texte de remplacement","key3":false}
[{"id":"bk101","author":{"lastname":"Gambardelle","firstname":"Matthew"},"title":"XML Developer's Guide","genre":"Computer","price":44.95000000,"publish_date":"2000-10-01","description":"An in-depth look at creating applications with XML.","available":true},{"id":"bk102","author":{"lastname":"Ralls","firstname":"Kim"},"title":"Midnight Rain","genre":"Fantasy","price":5.95000000,"publish_date":"2000-12-16","description":"A former architect battles corporate zombies, an evil sorceress, and her own childhood to become queen of the world.","available":true},{"id":"bk103","author":null,"title":"The Book With No Name","genre":"Thriller","price":21.00000000,"publish_date":"2006-07-08","description":"Santa Mondega is no ordinary town, and its inhabitants are even less ordinary: gangsters, martial-arts monks, low-lifes, bounty hunters, vampires and Elvis-impersonating hitmen abound. And then, in the shadowed streets, there lurks the serial killer known only as the Bourbon Kid.","available":false}]
</pre>

</div>

    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
        Connecté en tant que : L2 Informatique (l2info)      </div>
      <div class="doc">
        l2info/progc/json.txt · Dernière modification: 2018/12/07 16:21 par aspicher      </div>
    </div>

   
    <div class="bar" id="bar__bottom">
      <div class="bar-left" id="bar__bottomleft">
                              </div>
      <div class="bar-right" id="bar__bottomright">
                                        <form class="button btn_logout" method="get" action="/~aspicher/Wiki/l2info/progc/json"><div class="no"><input type="hidden" name="do" value="logout"><input type="hidden" name="sectok" value="aaab33518806b0c45d8e2bf49d6b3b47"><input type="submit" value="Déconnexion" class="button" title="Déconnexion"></div></form>                <a class="nolink" href="#dokuwiki__top"><input type="button" class="button" value="Haut de page" onclick="window.scrollTo(0, 0)" title="Haut de page"></a>&nbsp;
      </div>
      <div class="clearer"></div>
    </div>

  </div>

  <div class="license">Sauf mention contraire, le contenu de ce wiki est placé sous la licence suivante:<a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license" class="urlextern">CC Attribution-Noncommercial-Share Alike 3.0 Unported</a></div>
</div>

<div class="footerinc">

  <a href="http://lacl.fr/~aspicher/Wiki/feed.php" title="Recent changes RSS feed"><img src="Format%20JSON%20[Spicher]_fichiers/button-rss.png" alt="Recent changes RSS feed" width="80" height="15"></a>

        <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="license" title="CC Attribution-Noncommercial-Share Alike 3.0 Unported"><img src="Format%20JSON%20[Spicher]_fichiers/cc-by-nc-sa.png" alt="" width="80" height="15"></a>
  
  <a href="http://www.dokuwiki.org/donate" title="Donate"><img src="Format%20JSON%20[Spicher]_fichiers/button-donate.gif" alt="Donate" width="80" height="15"></a>

  <a href="http://www.php.net/" title="Powered by PHP"><img src="Format%20JSON%20[Spicher]_fichiers/button-php.gif" alt="Powered by PHP" width="80" height="15"></a>

  <a href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="Format%20JSON%20[Spicher]_fichiers/button-xhtml.png" alt="Valid XHTML 1.0" width="80" height="15"></a>

  <a href="http://jigsaw.w3.org/css-validator/check/referer?profile=css3" title="Valid CSS"><img src="Format%20JSON%20[Spicher]_fichiers/button-css.png" alt="Valid CSS" width="80" height="15"></a>

  <a href="http://dokuwiki.org/" title="Driven by DokuWiki"><img src="Format%20JSON%20[Spicher]_fichiers/button-dw.png" alt="Driven by DokuWiki" width="80" height="15"></a>



</div>

<div class="no"><img src="Format%20JSON%20[Spicher]_fichiers/indexer.gif" alt="" width="1" height="1"></div>


</body></html>